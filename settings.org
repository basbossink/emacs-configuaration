* Package repositories setup
To use the stable melpa packages replace
the melpa entry below with:
#+begin_src emacs-lisp :tangle no
(add-to-list
  'package-archives
  '("melpa-stable" . "https://stable.melpa.org/packages/")
  t)
#+end_src
#+begin_src emacs-lisp :tangle yes
(require 'package)
  (add-to-list
   'package-archives
   '("org" . "http://orgmode.org/elpa/")
   t)
  (add-to-list
    'package-archives
    '("melpa" . "https://melpa.org/packages/")
    t)
  (package-initialize)
  (unless package-archive-contents (package-refresh-contents))
#+end_src
* Keybindings
** iy-go-to-char
#+begin_src emacs-lisp :tangle yes
(add-to-list 'load-path "~/.emacs.d/iy-go-to-char")
(require 'iy-go-to-char)
(global-set-key (kbd "C-c f") 'iy-go-to-char)
(global-set-key (kbd "C-c F") 'iy-go-to-char-backward)
(global-set-key (kbd "C-c t") 'iy-go-up-to-char)
(global-set-key (kbd "C-c T") 'iy-go-up-to-char-backward)
(global-set-key (kbd "C-c ;") 'iy-go-to-or-up-to-continue)
(global-set-key (kbd "C-c ,") 'iy-go-to-or-up-to-continue-backward)
#+end_src
** org-mode
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c l") 'org-store-link)
#+end_src
** Time tracking
#+begin_src emacs-lisp :tangle yes
  (global-set-key [f10] 'timeclock-in)
  (global-set-key (kbd "S-<f10>") 'timeclock-change)
  (global-set-key [f11] 'timeclock-out)
  (global-set-key [f12] 'timeclock-interruption)
  (global-set-key (kbd "S-<f12>")'timeclock-visit-timelog)
#+end_src
** Magit
#+begin_src emacs-lisp :tangle yes
  (with-eval-after-load
      "magit"
    (progn
      (global-set-key (kbd "C-x g") 'magit-status)
      (define-key magit-status-mode-map (kbd "j i") 'magit-gitflow-init)
      (define-key magit-status-mode-map (kbd "j p") 'magit-gitflow-popup)
      (define-key magit-status-mode-map (kbd "j f s") 'magit-gitflow-feature-start)
      (define-key magit-status-mode-map (kbd "j f p") 'magit-gitflow-feature-publish)
      (define-key magit-status-mode-map (kbd "j f f") 'magit-gitflow-feature-finish)
      (define-key magit-status-mode-map (kbd "j r s") 'magit-gitflow-release-start)
      (define-key magit-status-mode-map (kbd "j r p") 'magit-gitflow-release-publish)
      (define-key magit-status-mode-map (kbd "j r f") 'magit-gitflow-release-finish)))

#+end_src
** Discover my major mode
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-h C-m") 'discover-my-major)
(global-set-key (kbd "C-h M-m") 'discover-my-mode)
#+end_src
** ACE window
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "M-o a") 'ace-window)
(global-set-key (kbd "M-o M-a") 'ace-window)
#+end_src
** ACE jump buffer
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "M-o M-b") (lambda () (interactive) (ace-jump-buffer)))
(global-set-key (kbd "M-o b") (lambda () (interactive) (ace-jump-buffer)))
#+end_src
** ACE jump mode
#+begin_src emacs-lisp :tangle yes
(define-key global-map (kbd "C-c C-SPC") 'ace-jump-mode)
#+end_src
*** ACE jump zap to char
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "M-p M-f") 'ace-jump-zap-to-char)
(global-set-key (kbd "M-p M-t") 'ace-jump-zap-up-to-char)
#+end_src
** ripgrep searching
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-S-f") 'ripgrep-regexp)
(global-set-key (kbd "<f6>") 'ripgrep-regexp-cs)
#+end_src
** Search all occurrances
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c o") 'occur)
(global-set-key (kbd "C-c O") 'multi-occur)
#+end_src

** Kill other buffers
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "C-c C-w") 'kill-other-buffers)
#+end_src
** Jump to next and previous error like VS
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "<f8>") 'next-error)
(global-set-key (kbd "S-<f8>") 'previous-error)
#+end_src
** Refresh buffer unconditionally
#+begin_src emacs-lisp :tangle yes
(global-set-key (kbd "<f5>") 'revert-buffer-without-confirm)
#+end_src
** Dired
#+begin_src emacs-lisp :tangle yes
  (eval-after-load
      "dired"
    '(define-key dired-mode-map
       [f3] (lambda ()
              (interactive)
              (w32-browser (dired-replace-in-string "/" "\\" (dired-get-filename))))))
#+end_src
** Hydra's
*** Zoom in-out
#+begin_src emacs-lisp :tangle yes
(defhydra hydra-zoom-in (global-map "C-x C-+")
  "zoom"
  ("+" text-scale-increase "in")
  ("-" text-scale-decrease "out"))

(defhydra hydra-zoom-out (global-map "C-x C--")
  "zoom"
  ("+" text-scale-increase "in")
  ("-" text-scale-decrease "out"))
#+end_src
*** Goto line
#+begin_src emacs-lisp :tangle yes
(defhydra hydra-goto-line (goto-map "")
  "goto-line"
  ("g" goto-line "go")
  ("m" set-mark-command "mark" :bind nil)
  ("q" nil "quit"))
#+end_src
*** Switch to buffer
**** Helper functions
#+begin_src emacs-lisp :tangle yes
(defun my/name-of-buffers (n)
  "Return the names of the first N buffers from `buffer-list'."
  (let ((bns
         (delq nil
               (mapcar
                (lambda (b)
                  (unless (string-match "^ " (setq b (buffer-name b)))
                    b))
                (buffer-list)))))
    (subseq bns 1 (min (1+ n) (length bns)))))

;; Given ("a", "b", "c"), return "1. a, 2. b, 3. c".
(defun my/number-names (list)
  "Enumerate and concatenate LIST."
  (let ((i 0))
    (mapconcat
     (lambda (x)
       (format "%d. %s" (cl-incf i) x))
     list
     ", ")))

(defvar my/last-buffers nil)

(defun my/switch-to-buffer (arg)
  (interactive "p")
  (switch-to-buffer
   (nth (1- arg) my/last-buffers)))

(defun my/switch-to-buffer-other-window (arg)
  (interactive "p")
  (switch-to-buffer-other-window
   (nth (1- arg) my/last-buffers)))
#+end_src
**** Keybinding
#+begin_src emacs-lisp :tangle yes
(global-set-key
 "\C-o"
 (defhydra my/switch-to-buffer (:exit t
                                :body-pre (setq my/last-buffers
                                                (my/name-of-buffers 4)))
   "
_o_ther buffers: %s(my/number-names my/last-buffers)

"
   ("o" my/switch-to-buffer "this window")
   ("O" my/switch-to-buffer-other-window "other window")
   ("<escape>" nil)))
#+end_src
*** Insert special characters
**** Helper functions
#+begin_src emacs-lisp :tangle yes
(defun my/insert-unicode (unicode-name)
       "Same as C-x 8 enter UNICODE-NAME."
       (insert-char (cdr (assoc-string unicode-name (ucs-names)))))
#+end_src
**** Keybinding
#+begin_src emacs-lisp :tangle yes
(global-set-key
  (kbd "C-x 9")
  (defhydra hydra-unicode (:hint nil)
   "
        Unicode  _e_ €  _s_ ZERO WIDTH SPACE _c_ ©
                 _f_ ♀  _o_ °   _m_ µ   _p_ ←
                 _g_ ♂  _r_ →   _t_ η   _l_ 😊
                 _d_ 👍 _a_ á _i_ Π
        "
   ("e" (my/insert-unicode "EURO SIGN"))
   ("g" (my/insert-unicode "MALE SIGN"))
   ("f" (my/insert-unicode "FEMALE SIGN"))
   ("s" (my/insert-unicode "ZERO WIDTH SPACE"))
   ("o" (my/insert-unicode "DEGREE SIGN"))
   ("a" (my/insert-unicode "LATIN SMALL LETTER A WITH ACUTE"))
   ("r" (my/insert-unicode "RIGHTWARDS ARROW"))
   ("m" (my/insert-unicode "MICRO SIGN"))
   ("t" (my/insert-unicode "GREEK SMALL LETTER ETA"))
   ("i" (my/insert-unicode "GREEK SMALL LETTER PI"))
   ("p" (my/insert-unicode "LEFTWARDS ARROW"))
   ("l" (my/insert-unicode "SMILING FACE WITH SMILING EYES"))
   ("d" (my/insert-unicode "THUMBS UP SIGN"))
   ("c" (my/insert-unicode "COPYRIGHT SIGN"))))
#+end_src
*** Find file
#+begin_src emacs-lisp :tangle yes
(global-set-key
 (kbd "C-x C-f")
 (defhydra my/find-file (:exit t
                         :hint nil)
   "find file"
   ("f" (ido-find-file) "find file")
   ("p" (find-file-at-point) "find file at point")
   ("o"  (ido-find-file-other-window) "find file other window")))
#+end_src
** Insert todays date in iso format
#+begin_src emacs-lisp :tangle yes
  (global-set-key "\C-x\M-d" 'insert-iso-date)
#+end_src
** Multiple cursors
#+begin_src emacs-lisp :tangle yes
(require 'multiple-cursors)
(global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
(global-set-key (kbd "C->") 'mc/mark-next-like-this)
(global-set-key (kbd "C-<") 'mc/mark-previous-like-this)
(global-set-key (kbd "C-c C-<") 'mc/mark-all-like-this)
#+end_src
** Open workday end form
#+begin_src emacs-lisp :tangle yes
  (global-set-key
   (kbd "<f9>")
   (lambda ()
     (interactive)
     (forms-find-file-other-window
      (expand-file-name "~/.emacs.d/forms/workday-end.el"))))
#+end_src
** Open positivity ratio form
#+begin_src emacs-lisp :tangle yes
  (global-set-key
   (kbd "<f7>")
   (lambda ()
     (interactive)
     (forms-find-file-other-window
      (expand-file-name "~/Dropbox/Personal/journals/positivy-form.el"))))
#+end_src
** Open recently visited file
#+begin_src emacs-lisp :tangle yes
  (global-set-key
   (kbd "C-x C-r")
   'recentf-ido-find-file)
#+end_src

** Use ivy for flyspell correction
#+BEGIN_SRC emacs-lisp :tangle yes
  (require 'flyspell-correct-ivy)
  (define-key flyspell-mode-map (kbd "C-;") 'flyspell-correct-wrapper)
  (setq flyspell-correct-interface #'flyspell-correct-ivy)
#+END_SRC
* Custom variables
** Look and feel
*** Set default font
#+begin_src emacs-lisp :tangle yes
  (set-face-font
    'default
    "DejaVu Sans Mono-10:antialias=subpixel")
  (set-face-attribute
    'default nil :height 100)
  (add-to-list
    'default-frame-alist
    '(font . "DejaVu Sans Mono-10:antialias=subpixel"))
#+end_src
*** Add symbola as unicode font
#+begin_src emacs-lisp :tangle yes
(when (member "Symbola" (font-family-list))
  (set-fontset-font t 'unicode "Symbola" nil 'prepend))
#+end_src
*** Highlight matching parentheses
#+begin_src emacs-lisp :tangle yes
(show-paren-mode)
#+end_src
*** Disable the scrollbar
#+begin_src emacs-lisp :tangle yes
(scroll-bar-mode -1)
#+end_src
*** Disable the toolbar
#+begin_src emacs-lisp :tangle yes
(tool-bar-mode -1)
#+end_src
*** Disable the startup screen
#+begin_src emacs-lisp :tangle yes
(setq inhibit-startup-screen t)
#+end_src
*** Themes
**** Set solarized related preferences before loading the theme
***** Make the fringe stand out from the background
#+begin_src emacs-lisp :tangle yes
(setq solarized-distinct-fringe-background t)
#+end_src
***** Don't change the font for some headings and titles
#+begin_src emacs-lisp :tangle yes
(setq solarized-use-variable-pitch nil)
#+end_src
***** Make the modeline high contrast
#+begin_src emacs-lisp :tangle yes
(setq solarized-high-contrast-mode-line t)
#+end_src
***** Don't change size of org-mode headlines (but keep other size-changes)
#+begin_src emacs-lisp :tangle yes
(setq solarized-scale-org-headlines nil)
#+end_src
**** Set theme to solarized light
#+begin_src emacs-lisp :tangle yes
(load-theme 'solarized-light t)
#+end_src
*** Show column number in mode line
#+begin_src emacs-lisp :tangle yes
(column-number-mode t)
#+end_src
*** Show the line number in the mode line
#+begin_src emacs-lisp :tangle yes
(line-number-mode 1)
#+end_src
*** Show the buffer size in the mode line
#+begin_src emacs-lisp :tangle yes
(size-indication-mode 1)
#+end_src
*** Show line numbers in the left margin
**** Enable linum mode globally
#+begin_src emacs-lisp :tangle yes
(global-linum-mode t)
#+end_src
**** Fix the font size of the line numbers
#+begin_src emacs-lisp :tangle yes
(eval-after-load "linum"
  '(set-face-attribute 'linum nil :family "Dejavu Sans Mono" :height 90 :slant 'normal :weight 'normal))
#+end_src
**** Set size of left fringe
#+begin_src emacs-lisp :tangle yes
(add-to-list 'default-frame-alist '(left-fringe . 10))
(add-to-list 'default-frame-alist '(right-fringe . 0))
#+end_src
**** Set linum format
#+begin_src emacs-lisp :tangle yes
  (setq-default linum-format 'dynamic)
#+end_src
*** Use a non-blinking cursor
#+begin_src emacs-lisp :tangle yes
(blink-cursor-mode 0)
#+end_src
*** Set language environment
#+begin_src emacs-lisp :tangle yes
(set-language-environment "UTF-8")
#+end_src
** Timetracking
*** Set timelog file
#+begin_src emacs-lisp :tangle yes
  (setq timeclock-file (expand-file-name "~/Dropbox/Personal/journals/timelog"))
#+end_src
** Ledger
*** Enable version check
#+begin_src emacs-lisp :tangle yes
(setq ledger-mode-should-check-version t)
#+end_src
*** Some shortcuts for a few reports
#+begin_src emacs-lisp :tangle yes
  (setq ledger-reports
    (quote (
       ("balance" "ledger balance")
       ("bal" "ledger -f %(ledger-file) bal")
       ("reg" "ledger -f %(ledger-file) reg")
       ("payee" "ledger -f %(ledger-file) reg @%(payee)")
       ("account" "ledger -f %(ledger-file) reg %(account)"))))
#+end_src
** Editing
*** Indentation
**** Use spaces instead of tabs
#+begin_src emacs-lisp :tangle yes
(setq-default indent-tabs-mode nil)
#+end_src
**** Set tab stops
#+begin_src emacs-lisp :tangle yes
(setq tab-stop-list (number-sequence 2 120 2))
#+end_src
**** Set tab width
#+begin_src emacs-lisp :tangle yes
(setq tab-width 2)
#+end_src
*** Disable use of mark when inactive
#+begin_src emacs-lisp :tangle yes
(setq mark-even-if-inactive nil)
#+end_src
*** Delete selected region when yanking text
#+begin_src emacs-lisp :tangle yes
(delete-selection-mode 1)
#+end_src
*** Sentences end with a single space
#+begin_src emacs-lisp :tangle yes
(setq sentence-end-double-space nil)
#+end_src
*** Allow upcase region command
#+begin_src emacs-lisp :tangle yes
(put 'upcase-region 'disabled nil)
#+end_src
*** Inhibit eol conversion (see if this removes ^M chars)
#+begin_src emacs-lisp :tangle no
  (setq inhibit-eol-conversion t)
#+end_src
*** Set file encoding according to os (disable for investigating hangs)
#+begin_src emacs-lisp :tangle no
  (if (equal 'windows-nt system-type)
      (progn (prefer-coding-system 'utf-8-dos)
             (setq-default buffer-file-coding-system 'utf-8-dos)
             (setf (alist-get "" file-coding-system-alist) '(utf-8-dos . utf-8-dos)))
    (progn (prefer-coding-system 'utf-8-unix)
           (setq-default buffer-file-coding-system 'utf-8-unix)
           (setf (alist-get "" file-coding-system-alist) '(utf-8-unix . utf-8-unix))))
#+end_src
** Backup settings; store all backup and autosave files in the tmp directory
#+begin_src emacs-lisp :tangle yes
(setq backup-directory-alist
      `((".*" . ,temporary-file-directory)))
(setq auto-save-file-name-transforms
            `((".*" ,temporary-file-directory t)))
#+end_src
** Use emacs server
#+begin_src emacs-lisp :tangle yes
(server-mode)
#+end_src
** Environment changes
*** Modify paths to a number of executables
**** Add find and diff to the exec-path
 #+begin_src emacs-lisp :tangle yes
 (setq exec-path
       (cons
        (expand-file-name "~/PortableApps/find/bin")
        (cons (expand-file-name "~/PortableApps/find/libexec")
              (cons (expand-file-name "~/PortableApps/diffutils/bin") exec-path))))
 #+end_src
**** Set find executable
 #+begin_src emacs-lisp :tangle yes
 (setq find-program (expand-file-name "~/PortableApps/find/bin/find.exe"))
 #+end_src
**** Set ispell executable to use to Hunspell
 #+begin_src emacs-lisp :tangle yes
   (add-to-list 'exec-path "c:/Users/bas/PortableApps/hunspell/bin")
   (setq-default ispell-program-name "hunspell")
   (setq ispell-dictionary "en_US")
 #+end_src
**** Set ledger executable to use
 #+begin_src emacs-lisp :tangle yes
 (setq ledger-binary-path "C:\\Users\\bas\\PortableApps\\ledger\\ledger.exe")
 #+end_src
** Enable features disabled by default
#+begin_src emacs-lisp :tangle yes
  (put 'dired-find-alternate-file 'disabled nil)
#+end_src
** Use y/n instead of yes/no
#+begin_src emacs-lisp :tangle yes
(fset 'yes-or-no-p 'y-or-n-p)
#+end_src
** Use empty scratch buffer
#+begin_src emacs-lisp :tangle yes
(setq initial-scratch-message nil)
#+end_src

** Set default browser chrome portable
#+begin_src emacs-lisp :tangle yes
  (defun my-browse-url-portable-chrome (url &rest ARGS)
    "Open URL in a new portable chrome app"
    (interactive (browse-url-interactive-arg "URL: "))
    (call-process "c:/Users/bas/PortableApps/PortableApps/GoogleChromePortable/GoogleChromePortable.exe" nil nil nil url))
  (setq browse-url-browser-function 'my-browse-url-portable-chrome)
#+end_src

* Dired
** Hide dot files by default
#+begin_src emacs-lisp :tangle yes
  (require 'dired-x)
  (setq-default dired-omit-files-p t) ; Buffer-local variable
  (setq dired-omit-files (concat dired-omit-files "\\|^\\..+$"))
#+end_src

* Spaceline
#+BEGIN_SRC emacs-lisp :tangle yes
  (require 'spaceline-config)
  (spaceline-emacs-theme)
#+END_SRC
* Ivy, Counsel, swiper
#+BEGIN_SRC emacs-lisp :tangle yes
  (ivy-mode 1)
  (global-set-key (kbd "C-s") 'counsel-grep-or-swiper)
  (setq counsel-grep-base-command
        "rg -i -M 120 --no-heading --line-number --color never '%s' %s")
  (setq ivy-use-virtual-buffers t)
  (setq ivy-count-format "(%d/%d) ")
  (global-set-key (kbd "M-x") 'counsel-M-x)
  (global-set-key (kbd "C-x C-f") 'counsel-find-file)
  (global-set-key (kbd "<f1> f") 'counsel-describe-function)
  (global-set-key (kbd "<f1> v") 'counsel-describe-variable)
  (global-set-key (kbd "<f1> l") 'counsel-find-library)
  (global-set-key (kbd "<f2> i") 'counsel-info-lookup-symbol)
  (global-set-key (kbd "<f2> u") 'counsel-unicode-char)
  (global-set-key (kbd "C-c C-r") 'ivy-resume)
  (global-set-key (kbd "C-x b") 'ivy-switch-buffer)

#+END_SRC
* Org mode configuration
** Export
** Fix beamer hyper setup
 #+begin_src emacs-lisp :tangle yes
   (customize-set-value 'org-latex-with-hyperref nil)
   (add-to-list 'org-latex-default-packages-alist "\\PassOptionsToPackage{hyphens}{url}")
 #+end_src
*** Set custom exporters
**** Markdown
 #+begin_src emacs-lisp :tangle yes
 (with-eval-after-load 'ox
   (require 'ox-md))
 #+end_src
**** Man
 #+begin_src emacs-lisp :tangle yes
 (with-eval-after-load 'ox
   (require 'ox-man))
 #+end_src
**** Confluence
 #+begin_src emacs-lisp :tangle yes
 (with-eval-after-load 'ox
   (require 'ox-confluence))
 #+end_src
**** Jira
 #+begin_src emacs-lisp :tangle yes
 (with-eval-after-load 'ox
   (require 'ox-jira))
 #+end_src

** Set auto fill mode for org mode files
#+begin_src emacs-lisp :tangle yes
(add-hook 'org-mode-hook 'auto-fill-mode)
#+end_src
** Babel
*** Paths for interpreters
#+begin_src emacs-lisp :tangle yes
(setq org-plantuml-jar-path (expand-file-name "~/PortableApps/plantuml/plantuml.jar"))
(setq org-babel-R-command (expand-file-name "~/Documents/R/R-3.3.1/bin/x64/R.exe --slave --no-save"))
(setq ob-mermaid-cli-path (expand-file-name "~/.node_modules/mmdc.cmd"))
(setq org-babel-python-command  "C:/tools/miniconda3/python.exe")
#+end_src
*** Set active Babel languages
#+begin_src emacs-lisp :tangle yes
(org-babel-do-load-languages
 'org-babel-load-languages
 '(
   (plantuml . t)
   (python . t)
   (mermaid . t)
   (emacs-lisp . t)
   (dot . t)
   (ditaa . t)
   ))
#+end_src
** Set org mode preference variables
#+begin_src emacs-lisp :tangle yes
(setq org-confirm-babel-evaluate nil)
(setq org-pretty-entities t)
(setq org-export-with-sub-superscripts nil)
(require 'ox-latex)
(add-to-list 'org-latex-packages-alist '("" "minted"))
(setq org-latex-listings 'minted)
(setq org-latex-pdf-process
      '("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
        "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
        "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))
#+end_src
** Make yasnippets and org-mode work together
#+begin_src emacs-lisp :tangle yes
(add-hook 'org-mode-hook
          (lambda ()
            (org-set-local 'yas/trigger-key [tab])
            (define-key yas/keymap [tab] 'yas/next-field-or-maybe-expand)))
(defun yas/org-very-safe-expand ()
  (let ((yas/fallback-behavior 'return-nil)) (yas/expand)))
(add-hook 'org-mode-hook
          (lambda ()
            (make-variable-buffer-local 'yas/trigger-key)
            (setq yas/trigger-key [tab])
            (add-to-list 'org-tab-first-hook 'yas/org-very-safe-expand)
            (define-key yas/keymap [tab] 'yas/next-field)))

#+end_src
** Set up files to include in agenda
#+begin_src emacs-lisp :tangle yes
(setq org-agenda-files (mapcar (lambda (f) (expand-file-name (concat "~/Dropbox/Personal/journals/" f))) '("2017.org" "divverence.org")))
#+end_src
* Time tracking
#+begin_src emacs-lisp :tangle yes
(require 'timeclock)
#+end_src
** Add timeclock to modeline
#+begin_src emacs-lisp :tangle yes
(timeclock-modeline-display)
#+end_src
** Ask to clock out when emacs closes
#+begin_src emacs-lisp :tangle yes
(add-hook 'kill-emacs-query-functions 'timeclock-query-out)
#+end_src
** Define a custom function to handle interruptions
#+begin_src emacs-lisp :tangle yes
(defun timeclock-interruption ()
  "Provide administiring an interuption with a single key stroke."
  (interactive)
  (timeclock-out "Interruption")
  (timeclock-in 0 "Interruption" nil))
#+end_src
** Set epresent-run hook
#+begin_src emacs-lisp :tangle yes
  (add-hook 'epresent-start-presentation-hook
            (lambda ()
              (global-display-line-numbers-mode -1)
              (global-linum-mode -1)))
#+end_src

* Magit
** Initialize
*** Set Log margin format before magit loads
#+begin_src emacs-lisp :tangle yes
(setq magit-log-margin '(t "%Y-%m-%dT%H:%M:%S %z" 47 t 20))
#+end_src
*** Load magit
#+begin_src emacs-lisp :tangle yes
(require 'magit)
#+end_src
** Gitflow
#+begin_src emacs-lisp :tangle yes
(require 'magit-gitflow)
(add-hook 'magit-mode-hook 'turn-on-magit-gitflow)
#+end_src
** SSH authentication
#+begin_src emacs-lisp :tangle yes
(add-to-list 'load-path "~/.emacs.d/ssh-agency")
(require 'ssh-agency)
(setenv "SSH_ASKPASS" "git-gui--askpass")
#+end_src
** Log parameters 
Disabled, see [[https://github.com/magit/magit/commit/4641aa07e0b1f4654fceb139a36b160d594d7846][Magit log arguments refactoring]]
#+begin_src emacs-lisp :tangle no
(add-to-list 'magit-log-arguments "--graph")
(add-to-list 'magit-log-arguments "--decorate")
(add-to-list 'magit-log-arguments "-n256")
#+end_src
** Commit hook setup
#+begin_src emacs-lisp :tangle yes
(defun my-git-commit-setup-hook ()
  (progn (electric-pair-mode 1)
         (git-commit-turn-on-flyspell)
         (git-commit-turn-on-auto-fill)))
(add-hook 'git-commit-setup-hook 'my-git-commit-setup-hook)
#+end_src
** Set fill column for commit messages
Note that git-commit-fill-column and git-commit-summary-max-length
have to be set to *numberp* values
#+begin_src emacs-lisp :tangle yes
(setq git-commit-fill-column 72)
(setq-default git-commit-summary-max-length 50)
#+end_src
* Mingus (MPD client)
** Mode-line configuration
#+begin_src emacs-lisp :tangle yes
 (setq mingus-mode-line-show-consume-and-single-status nil)
 (setq mingus-mode-line-show-elapsed-time t)
 (setq mingus-mode-line-show-random-and-repeat-status nil)
 (setq mingus-mode-line-show-status nil)
 (setq mingus-mode-line-show-volume nil)
 (setq mingus-mode-line-string-max 280)

#+end_src
* Gnugo
#+begin_src emacs-lisp :tangle yes
(setq gnugo-program "c:/Users/bas/PortableApps/gnugo/gnugo.exe")
#+end_src
* Lilypond
** Add lilypond dir to load path
#+begin_src emacs-lisp :tangle yes
  (add-to-list 'load-path (expand-file-name "lilypond" "~/.emacs.d"))
#+end_src
** Autoload lilypond for ly files
#+begin_src emacs-lisp :tangle yes
  (autoload 'LilyPond-mode "lilypond-mode")
  (setq auto-mode-alist
        (cons '("\\.ly\\'" . LilyPond-mode) auto-mode-alist))

  (add-hook 'LilyPond-mode-hook (lambda () (turn-on-font-lock)))
#+end_src

* Programming language modes
** C#
*** Hooks; enable electric pair mode
#+begin_src emacs-lisp :tangle yes
  (defun my-csharp-mode-hook ()
    (electric-pair-mode 1)
    (omnisharp-mode)
    (setq indent-tabs-mode nil)
    (setq c-syntactic-indentation t)
    (c-set-style "ellemtel")
    (setq c-basic-offset 4)
    (setq truncate-lines t)
    (setq tab-width 4)
    (setq evil-shift-width 4)
    (local-set-key (kbd "C-c C-c") 'recompile))
  (add-hook 'csharp-mode-hook 'my-csharp-mode-hook)
#+end_src
** Markdown
*** Use pandoc to compile markdown
#+begin_src emacs-lisp :tangle yes
(setq markdown-command "pandoc")
#+end_src
*** Disable removal of trailing whitespace
#+begin_src emacs-lisp :tangle yes
  (defun turn-off-delete-trailing-whitespace ()
    (message "Turning of removal of trailing whitespace in Markdown mode.")
    (setq write-file-functions (delete 'delete-trailing-whitespace write-file-functions)))
  (add-hook 'markdown-mode-hook 'turn-off-delete-trailing-whitespace)
#+end_src
*** Turn on orgstruct++ mode when using markdown > disabled
#+begin_src emacs-lisp :tangle no
(add-hook 'markdown-mode-hook 'orgstruct++-mode)
#+end_src
*** Turn on flyspell mode when using markdown
#+begin_src emacs-lisp :tangle yes
(add-hook 'markdown-mode-hook 'flyspell-mode)
#+end_src

** Clojure
*** CIDER default repl disabled
#+begin_src emacs-lisp :tangle no
(setq cider-jack-in-default 'boot)
#+end_src

** F#
*** Initialize
#+begin_src emacs-lisp :tangle yes
(require 'fsharp-mode)
#+end_src
*** Indentation
#+begin_src emacs-lisp :tangle yes
(setq fsharp-continuation-offset 2)
(setq fsharp-indent-level 2)
#+end_src
** JSON
*** Set indent width to 2
#+begin_src emacs-lisp :tangle yes
(setq json-reformat:indent-width 2)
(add-hook 'json-mode-hook
          (lambda ()
            (make-local-variable 'js-indent-level)
            (setq js-indent-level 2)))
#+end_src
** Elixir Alchemist
*** Setup paths to Elixir tools
 #+begin_src emacs-lisp :tangle yes
 (setq elixir-path "/ProgramData/chocolatey/lib/Elixir/bin/")
 (setq alchemist-mix-command (concat elixir-path "mix"))
 (setq alchemist-iex-program-name (concat elixir-path "iex"))
 (setq alchemist-execute-command (concat elixir-path "elixir"))
 (setq alchemist-compile-command (concat elixir-path "elixirc"))
 #+end_src
*** Hooks
**** Run tests on save
 #+begin_src emacs-lisp :tangle yes
(setq alchemist-hooks-test-on-save t)
 #+end_src
**** Add credo flycheck mode to elixir mode
 #+begin_src emacs-lisp :tangle yes
(eval-after-load 'flycheck
  '(flycheck-credo-setup))
(add-hook 'elixir-mode-hook 'flycheck-mode)
 #+end_src
**** Use strict mode when calling credo from flycheck
 #+begin_src emacs-lisp :tangle yes
(setq flycheck-elixir-credo-strict t)
 #+end_src

** Elm
*** Hooks
**** Use oracle for completion
#+begin_src emacs-lisp :tangle yes
(add-hook 'elm-mode-hook #'elm-oracle-setup-completion)
#+end_src
** Rust
*** Enable format on save
#+begin_src emacs-lisp :tangle yes
(setq rust-format-on-save t)
#+end_src
*** Enable Racer
#+begin_src emacs-lisp :tangle yes
(add-hook 'rust-mode-hook #'racer-mode)
(add-hook 'racer-mode-hook #'eldoc-mode)
#+end_src
*** Enable Compay mode completion with Racer
#+begin_src emacs-lisp :tangle yes
(add-hook 'racer-mode-hook #'company-mode)
(require 'rust-mode)
(define-key rust-mode-map (kbd "TAB") #'company-indent-or-complete-common)
(setq company-tooltip-align-annotations t)
#+end_src
** TypeScript
*** Mode hook function
#+begin_src emacs-lisp :tangle yes
(defun setup-tide-mode ()
  (interactive)
  (tide-setup)
  (flycheck-mode +1)
  (setq flycheck-check-syntax-automatically '(save mode-enabled))
  (eldoc-mode +1)
  (tide-hl-identifier-mode +1)
  (company-mode +1))
#+end_src
*** Align annotation to the right hand side
#+begin_src emacs-lisp :tangle yes
(setq company-tooltip-align-annotations t)
#+end_src
*** Format the buffer before saving
#+begin_src emacs-lisp :tangle yes
(add-hook 'before-save-hook 'tide-format-before-save)
#+end_src
*** Add mode hook
#+begin_src emacs-lisp :tangle yes
(add-hook 'typescript-mode-hook #'setup-tide-mode)
#+end_src
*** Set format options
#+begin_src emacs-lisp :tangle yes
(setq tide-format-options '(:insertSpaceAfterFunctionKeywordForAnonymousFunctions t :placeOpenBraceOnNewLineForFunctions))
#+end_src
*** Enable tide for tsx files
#+begin_src emacs-lisp :tangle yes
(require 'web-mode)
(add-to-list 'auto-mode-alist '("\\.tsx\\'" . web-mode))
(add-hook 'web-mode-hook
          (lambda ()
            (when (string-equal "tsx" (file-name-extension buffer-file-name))
              (setup-tide-mode))))
#+end_src
** Julia
#+begin_src emacs-lisp :tangle yes
  (add-to-list 'load-path "~/.emacs.d/julia-emacs/")
  (require 'julia-mode)
#+end_src

** Mermaid
#+begin_src emacs-lisp :tangle yes
  (add-to-list 'load-path "~/.emacs.d/mermaid-mode/")
  (require 'mermaid-mode)
  (setq mermaid-output-format 'svg)
  (setq mermaid-compiler ob-mermaid-cli-path)
#+end_src

#+RESULTS:

** Web mode
*** Enable web-mode for web-ish file types
#+begin_src emacs-lisp :tangle yes
(require 'web-mode)
(add-to-list 'auto-mode-alist '("\\.phtml\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.tpl\\.php\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.[agj]sp\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.as[cp]x\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.erb\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.mustache\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.djhtml\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
#+end_src
*** Configure layouting
#+begin_src emacs-lisp :tangle yes
  (defun my-web-mode-hook ()
    "Hooks for Web mode."
    (setq web-mode-enable-auto-pairing t)
    (setq web-mode-markup-indent-offset 2)
    (setq web-mode-code-indent-offset 2)
    (setq web-mode-css-indent-offset 2)
    (set (make-local-variable 'company-backends) '(company-css company-web-html company-yasnippet company-files)))
  (add-hook 'web-mode-hook  'my-web-mode-hook)
#+end_src
** Programming mode hooks
*** Remove trailing whitespace
#+begin_src emacs-lisp :tangle yes
  (add-hook 'prog-mode-hook
            (lambda ()
              (flyspell-prog-mode)
              (add-to-list
               'write-file-functions
               'delete-trailing-whitespace)))
#+end_src
* Other minor modes
** ACE jump mode
#+begin_src emacs-lisp :tangle yes
(autoload
  'ace-jump-mode-pop-mark
  "ace-jump-mode"
  "Ace jump back:-)"
  t)
(eval-after-load "ace-jump-mode"
  '(ace-jump-mode-enable-mark-sync))
#+end_src
** Smart parens
#+begin_src emacs-lisp :tangle yes
(require 'smartparens-config)
(add-hook 'prog-mode-hook 'turn-on-smartparens-mode)
(add-hook 'markdown-mode-hook 'turn-on-smartparens-mode)
#+end_src
** YASnippet
*** Enable globally
#+begin_src emacs-lisp :tangle yes
(yas-global-mode 1)
#+end_src
** Completion
*** Company mode
**** Enable globally
#+begin_src emacs-lisp :tangle yes
(add-hook 'after-init-hook 'global-company-mode)
#+end_src
**** Use case sensitive completion for dabbrev
#+begin_src emacs-lisp :tangle yes
  (with-eval-after-load "company"
    (setq company-dabbrev-downcase nil))

#+end_src

**** Enable Python backend
#+begin_src emacs-lisp :tangle yes
(add-hook 'python-mode-hook 'anaconda-mode)
(eval-after-load "company"
 '(add-to-list 'company-backends 'company-anaconda))
#+end_src
**** Enable Elm backend
#+begin_src emacs-lisp :tangle yes
(add-to-list 'company-backends 'company-elm)
#+end_src
**** Enable Omnisharp backend
#+begin_src emacs-lisp :tangle yes
(eval-after-load
 'company
 '(add-to-list 'company-backends 'company-omnisharp))
#+end_src
**** Enable emojifi backend
#+begin_src emacs-lisp :tangle yes
  (require 'company-emoji)
  (eval-after-load
   'company
   '(add-to-list 'company-backends 'company-emoji))
#+end_src

*** IDO
**** Initialize
#+begin_src emacs-lisp :tangle yes
(require 'ido)
#+end_src
**** Enable globally
#+begin_src emacs-lisp :tangle yes
(ido-mode t)
#+end_src
** Abbreviations
*** Enable globally
#+begin_src emacs-lisp :tangle yes
(setq-default abbrev-mode t)
#+end_src
*** Read abbrevs file
#+begin_src emacs-lisp :tangle yes
(if (file-exists-p abbrev-file-name)
    (quietly-read-abbrev-file))
#+end_src
*** Save abbrevs file
#+begin_src emacs-lisp :tangle yes
(setq save-abbrevs t)
#+end_src
** Editorconfig
#+begin_src emacs-lisp :tangle yes
(editorconfig-mode 1)
#+end_src
** Plantuml mode
*** Set jar path
 #+begin_src emacs-lisp :tangle yes
 (setq plantuml-jar-path org-plantuml-jar-path)
 #+end_src
*** autamatically enable plantuml mode for .uml files
#+begin_src emacs-lisp :tangle yes
(add-to-list 'auto-mode-alist '("\\.uml\\'" . plantuml-mode))
#+end_src

** Mermaid mode
*** Set tab width to 4 spaces
#+begin_src emacs-lisp :tangle yes
  (add-hook 'mermaid-mode-hook
            (lambda ()
              (setq tab-width 4)))
#+end_src
*** autamatically enable mermaid mode for .mmd files
#+begin_src emacs-lisp :tangle yes
  (add-to-list 'auto-mode-alist '("\\.mmd\\'" . plantuml-mode))
#+end_src
** Show number of search matches in mode line
#+begin_src emacs-lisp :tangle yes
  (global-anzu-mode +1)
#+end_src
** Vlf (Very large file mode)
#+begin_src emacs-lisp :tangle yes
  (add-hook 'vlf-mode-hook
            (lambda ()
              (setq buffer-read-only t)
              (buffer-disable-undo)
              (font-lock-mode -1)
              (visual-line-mode -1)
              (setq truncate-lines 1)
              (auto-revert-tail-mode)
              (company-mode 0)
              (abbrev-mode 0)))
#+end_src
** Recent files
#+begin_src emacs-lisp :tangle yes
  (require 'recentf)
  (setq recentf-max-saved-items 200
        recentf-max-menu-items 15)
  (recentf-mode +1)

  (defun recentf-ido-find-file ()
    "Find a recent file using ido."
    (interactive)
    (let ((file (ido-completing-read "Choose recent file: " recentf-list nil t)))
      (when file
        (find-file file))))
#+end_src
** Dimmer non active windows
#+begin_src emacs-lisp :tangle yes
  (dimmer-mode)
  (setq dimmer-fraction 0.4)
#+end_src
** Smart hungry delete of whitespace
#+begin_src emacs-lisp :tangle yes
  (require 'smart-hungry-delete)
  (smart-hungry-delete-add-default-hooks)
  (global-set-key (kbd "<backspace>") 'smart-hungry-delete-backward-char)
  (global-set-key (kbd "C-d") 'smart-hungry-delete-forward-char)
#+end_src

* Popup kill ring
#+BEGIN_SRC emacs-lisp :tangle yes
  (require 'popup-kill-ring)
  (global-set-key (kbd "M-y") 'popup-kill-ring)
#+END_SRC
* Custom functions
** Hooks
*** Disable some stuff for large files
#+begin_src emacs-lisp :tangle yes
(defun my-find-file-check-make-large-file-read-only-hook ()
  "If a file is over a given size, make the buffer read only."
  (when (> (buffer-size) (* 1024 1024 10))
    (my-disable-stuff-for-large-files)
    (fundamental-mode)))

(add-hook 'find-file-hook 'my-find-file-check-make-large-file-read-only-hook)
#+end_src
*** Set fill-column to 180 when editing CHANGELOG.md
#+begin_src emacs-lisp :tangle yes
  (defun set-changelog-fill-column-hook ()
    (when
        (and
         (string= (file-name-base buffer-file-name) "CHANGELOG")
         (string= (file-name-extension buffer-file-name) "md"))
      (setq fill-column 180)))

  (add-hook 'find-file-hook 'set-changelog-fill-column-hook)
#+end_src

*** Use auto-revert-tail-mode for log files
#+begin_src emacs-lisp :tangle yes
 (add-to-list 'auto-mode-alist '("\\.log\\'" . auto-revert-tail-mode))
#+end_src
*** Disable some stuff when using auto-revert-tail-mode
#+begin_src emacs-lisp :tangle yes
(add-hook 'auto-revert-tail-mode-hook 'my-disable-stuff-for-large-files)
#+end_src

** Other functions
*** Ripgrep through C# files only
#+begin_src emacs-lisp :tangle yes
  (defun ripgrep-regexp-cs (regexp dir)
    (interactive "sRegex: \nDDirectory: ")
    (ripgrep-regexp regexp dir '("-t" "cs")))
#+end_src
*** Kill all other buffers
#+begin_src emacs-lisp :tangle yes
 (defun kill-other-buffers ()
   "Kill all other buffers."
   (interactive)
   (mapc 'kill-buffer (delq (current-buffer) (buffer-list))))
#+end_src
*** Revert buffer without confirmation
#+begin_src emacs-lisp :tangle yes
 (defun revert-buffer-without-confirm ()
   "Revert the current buffer without asking for a confirmation."
   (interactive)
   (revert-buffer t t t))
#+end_src
*** Toggle window split between horizontal and vertical
#+begin_src emacs-lisp :tangle yes
 (defun toggle-window-split ()
   (interactive)
   (if (= (count-windows) 2)
       (let* ((this-win-buffer (window-buffer))
          (next-win-buffer (window-buffer (next-window)))
          (this-win-edges (window-edges (selected-window)))
          (next-win-edges (window-edges (next-window)))
          (this-win-2nd (not (and (<= (car this-win-edges)
                      (car next-win-edges))
                      (<= (cadr this-win-edges)
                      (cadr next-win-edges)))))
          (splitter
           (if (= (car this-win-edges)
              (car (window-edges (next-window))))
           'split-window-horizontally
         'split-window-vertically)))
     (delete-other-windows)
     (let ((first-win (selected-window)))
       (funcall splitter)
       (if this-win-2nd (other-window 1))
       (set-window-buffer (selected-window) this-win-buffer)
       (set-window-buffer (next-window) next-win-buffer)
       (select-window first-win)
       (if this-win-2nd (other-window 1))))))
#+end_src
*** Open file based on windows extension
#+begin_src emacs-lisp :tangle yes
  (defun w32-browser (doc)
    (w32-shell-execute 1 doc))
#+end_src
*** Disable some modes for large files
#+begin_src emacs-lisp :tangle yes
  (defun my-disable-stuff-for-large-files ()
              (setq buffer-read-only t)
              (buffer-disable-undo)
              (font-lock-mode -1)
              (visual-line-mode -1)
              (setq truncate-lines 1)
              (company-mode 0)
              (abbrev-mode 0))
#+end_src
*** Insert date in iso format
#+begin_src emacs-lisp :tangle yes
  (defun insert-iso-date ()
    (interactive)
    (insert (format-time-string "%F")))
#+end_src

* Start up actions
** Start Mingus (MPD client)
#+begin_src emacs-lisp :tangle yes
 (mingus)
#+end_src
** Start IPython
#+begin_src emacs-lisp :tangle yes
 (ipython)
#+end_src

** Start PowerShell
#+begin_src emacs-lisp :tangle yes
 (powershell)
#+end_src

** Start eshell
#+begin_src emacs-lisp :tangle yes
 (eshell)
#+end_src

** Start dired in Divverence
#+begin_src emacs-lisp :tangle yes
 (dired "F:/")
 (dired "~")
#+end_src

** Allow Very large file mode to prompt
#+begin_src emacs-lisp :tangle yes
 (require 'vlf-setup)
#+end_src

** Start Global emojify mode.
#+begin_src emacs-lisp :tangle yes
(add-hook 'after-init-hook #'global-emojify-mode)
#+end_src
** Start workday start form (disabled)
#+begin_src emacs-lisp :tangle no
  (add-hook
   'after-init-hook
   (lambda ()
     (forms-find-file-other-window
      (expand-file-name "~/.emacs.d/forms/workday-start.el"))))
#+end_src
